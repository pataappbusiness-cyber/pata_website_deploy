/* ============================================
   SECTION 14: RESERVAR O LUGAR - JavaScript
   Form validation, submission, and image carousel
   Version: 9.0 - FIX 403 cross-origin
   ============================================ */

'use strict';

/* =================================









===========
   CONFIGURATION
   ============================================ */

const RESERVAR_CONFIG = {
  GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzw_TQ0TFaHOzea7Ev4IL8Je6EjE4jH_w-brF6ssIQXzzfIQf6z8dKuUNLJv_huNDQ8/exec',
  COUNT_ACTION_URL: 'https://script.google.com/macros/s/AKfycbzw_TQ0TFaHOzea7Ev4IL8Je6EjE4jH_w-brF6ssIQXzzfIQf6z8dKuUNLJv_huNDQ8/exec',

  MAX_SPOTS: 500,
  CAROUSEL_INTERVAL: 5000,
  DEBUG_MODE: false
};

/* ============================================
   IMAGE CAROUSEL
   ============================================ */

class ReservarCarousel {
  constructor() {
    this.images = document.querySelectorAll('.reservar-carousel-image');
    this.currentIndex = 0;
    this.intervalId = null;

    if (this.images.length > 0) {
      this.init();
    }
  }

  init() {
    this.intervalId = setInterval(() => this.nextImage(), RESERVAR_CONFIG.CAROUSEL_INTERVAL);
    console.log('ðŸŽ  Reservar carousel initialized');
  }

  nextImage() {
    this.images[this.currentIndex].classList.remove('active');
    this.currentIndex = (this.currentIndex + 1) % this.images.length;
    setTimeout(() => {
      this.images[this.currentIndex].classList.add('active');
    }, 500);
  }

  destroy() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
    }
  }
}

/* ============================================
   FORM VALIDATION
   ============================================ */

class ReservarFormValidator {
  constructor(formId) {
    this.form = document.getElementById(formId);
    if (!this.form) return;

    this.fields = {
      nome: document.getElementById('reservarNome'),
      email: document.getElementById('reservarEmail'),
      distrito: document.getElementById('reservarDistrito'),
      animal: document.getElementById('reservarAnimal'),
      privacy: document.getElementById('reservarPrivacy')
    };

    this.init();
  }

  init() {
    Object.values(this.fields).forEach(field => {
      if (field) {
        field.addEventListener('blur', () => this.validateField(field));
        field.addEventListener('input', () => this.clearFieldError(field));
      }
    });
    console.log('âœ… Reservar form validation initialized');
  }

  validateField(field) {
    const fieldId = field.id.replace('reservar', '').toLowerCase();
    const value = field.value.trim();
    let isValid = true;
    let errorMessage = '';

    switch (fieldId) {
      case 'nome':
        if (!value) { isValid = false; errorMessage = 'Tem de inserir o nome.'; }
        break;
      case 'email':
        if (!value || !this.isValidEmail(value)) { isValid = false; errorMessage = 'Email invÃ¡lido.'; }
        break;
      case 'distrito':
        if (!value) { isValid = false; errorMessage = 'Selecione um distrito.'; }
        break;
      case 'animal':
        if (!value) { isValid = false; errorMessage = 'Selecione uma opÃ§Ã£o.'; }
        break;
      case 'privacy':
        if (!field.checked) { isValid = false; errorMessage = 'Tem de aceitar a PolÃ­tica de Privacidade.'; }
        break;
    }

    if (!isValid) {
      this.showFieldError(field, errorMessage);
    } else {
      this.clearFieldError(field);
    }
    return isValid;
  }

  validateForm() {
    let isValid = true;
    Object.values(this.fields).forEach(field => {
      if (field && !this.validateField(field)) {
        isValid = false;
      }
    });
    return isValid;
  }

  showFieldError(field, message) {
    field.classList.add('error');
    field.setAttribute('aria-invalid', 'true');
    const errorElement = document.getElementById(`${field.id}Error`);
    if (errorElement) {
      errorElement.textContent = message;
      errorElement.classList.add('show');
    }
  }

  clearFieldError(field) {
    field.classList.remove('error');
    field.setAttribute('aria-invalid', 'false');
    const errorElement = document.getElementById(`${field.id}Error`);
    if (errorElement) {
      errorElement.classList.remove('show');
    }
  }

  isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  resetForm() {
    this.form.reset();
    Object.values(this.fields).forEach(field => {
      if (field) this.clearFieldError(field);
    });
  }
}

/* ============================================
   FORM SUBMISSION
   ============================================ */

class ReservarFormSubmitter {
  constructor(formId, validator) {
    this.form = document.getElementById(formId);
    this.validator = validator;
    this.submitButton = document.getElementById('reservarSubmitBtn');
    this.recaptchaReady = false;

    if (!this.form) return;

    this.init();
    this.initRecaptcha();
  }

  initRecaptcha() {
    const checkRecaptcha = () => {
      if (typeof grecaptcha !== 'undefined' && grecaptcha.ready) {
        grecaptcha.ready(() => {
          this.recaptchaReady = true;
          console.log('âœ… reCAPTCHA ready');
        });
      } else {
        setTimeout(checkRecaptcha, 100);
      }
    };
    checkRecaptcha();
  }

  init() {
    this.form.addEventListener('submit', (e) => this.handleSubmit(e));
    console.log('âœ… Reservar form submission initialized');
  }

  async handleSubmit(e) {
    e.preventDefault();

    if (!this.validator.validateForm()) return;

    if (!this.recaptchaReady) {
      alert('Por favor, aguarde enquanto o reCAPTCHA estÃ¡ a carregar...');
      return;
    }

    this.submitButton.disabled = true;
    this.submitButton.textContent = 'A enviar...';

    if (typeof grecaptcha !== 'undefined' && grecaptcha.ready) {
      try {
        await new Promise((resolve) => grecaptcha.ready(resolve));

        const token = await grecaptcha.execute('6Le6-2EsAAAAAC35zcOC3-2jVhmztQL_yMNh5YEb', { action: 'waitlist_signup' });

        const formData = {
          nome: document.getElementById('reservarNome').value.trim(),
          email: document.getElementById('reservarEmail').value.trim(),
          distrito: document.getElementById('reservarDistrito').value,
          animal: document.getElementById('reservarAnimal').value,
          marketing: document.getElementById('reservarMarketing').checked ? 'Sim' : 'NÃ£o',
          timestamp: new Date().toISOString(),
          'g-recaptcha-response': token
        };

        try {
          const result = await this.submitToGoogleScript(formData);

          if (result.success) {
            this.showSuccessModal();
            this.validator.resetForm();
            setTimeout(() => loadRemainingSpots(), 1000);

            if (RESERVAR_CONFIG.DEBUG_MODE) {
              console.log('âœ… Form submitted successfully:', result);
            }
          } else {
            alert(result.message || 'Ocorreu um erro ao enviar o formulÃ¡rio. Por favor, tente novamente.');
            console.error('âŒ Server error:', result.message);
          }
        } catch (error) {
          alert('Ocorreu um erro ao enviar o formulÃ¡rio. Por favor, tente novamente.');
          console.error('âŒ Form submission error:', error);
        } finally {
          this.submitButton.disabled = false;
          this.submitButton.textContent = 'Garantir PreÃ§o de Fundador (â‚¬7,99/mÃªs)';
        }
      } catch (error) {
        console.error('âŒ reCAPTCHA error:', error);
        alert('Erro ao verificar reCAPTCHA. Por favor, tente novamente.');
        this.submitButton.disabled = false;
        this.submitButton.textContent = 'Garantir PreÃ§o de Fundador (â‚¬7,99/mÃªs)';
      }
    } else {
      alert('Erro ao carregar reCAPTCHA. Por favor, recarregue a pÃ¡gina.');
      this.submitButton.disabled = false;
      this.submitButton.textContent = 'Garantir PreÃ§o de Fundador (â‚¬7,99/mÃªs)';
    }
  }

  /**
   * Submit to Google Apps Script
   * 
   * Strategy: fetch() with redirect:'follow' sends JSON POST.
   * Google Apps Script web apps DO support CORS when deployed as "Anyone".
   * The 302 redirect is followed automatically to the /echo response URL.
   * 
   * If CORS fails on certain browsers, falls back to no-cors + JSONP verify.
   */
  submitToGoogleScript(formData) {
    return new Promise(async (resolve, reject) => {
      const jsonPayload = JSON.stringify(formData);

      // â”€â”€ ATTEMPT 1: fetch with CORS (gets real response) â”€â”€
      try {
        console.log('ðŸ“¨ Attempt 1: fetch with CORS...');

        const response = await fetch(RESERVAR_CONFIG.GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: jsonPayload,
          redirect: 'follow'
        });

        if (response.ok) {
          const result = await response.json();
          console.log('âœ… CORS fetch succeeded:', result);
          resolve(result);
          return;
        }

        console.warn('âš ï¸ CORS fetch status:', response.status);
        // Fall through to attempt 2
      } catch (corsError) {
        console.warn('âš ï¸ CORS fetch failed:', corsError.message);
        // Fall through to attempt 2
      }

      // â”€â”€ ATTEMPT 2: no-cors + JSONP verification â”€â”€
      try {
        console.log('ðŸ“¨ Attempt 2: no-cors + JSONP...');

        // Record count BEFORE submission
        let countBefore = -1;
        try {
          const beforeResult = await this.getCountViaJSONP();
          countBefore = beforeResult.count;
          console.log('ðŸ“Š Count before:', countBefore);
        } catch (e) {
          console.warn('âš ï¸ Could not get pre-count');
        }

        // Fire-and-forget POST (no readable response with no-cors)
        await fetch(RESERVAR_CONFIG.GOOGLE_SCRIPT_URL, {
          method: 'POST',
          body: jsonPayload,
          mode: 'no-cors',
          redirect: 'follow'
        });

        // Wait for Google Apps Script to process
        console.log('â³ Waiting for GAS to process...');
        await new Promise(r => setTimeout(r, 4000));

        // Verify: did the count increase?
        try {
          const afterResult = await this.getCountViaJSONP();
          const countAfter = afterResult.count;
          console.log('ðŸ“Š Count after:', countAfter);

          if (countBefore >= 0 && countAfter > countBefore) {
            console.log('âœ… Verified: count increased from', countBefore, 'to', countAfter);
            resolve({ success: true, message: 'SubmissÃ£o bem-sucedida!' });
          } else if (countBefore >= 0 && countAfter === countBefore) {
            // Count didn't change - could be duplicate email or reCAPTCHA failure
            console.warn('âš ï¸ Count unchanged - possible duplicate or validation error');
            resolve({
              success: false,
              message: 'O email jÃ¡ estÃ¡ na lista ou ocorreu um erro de validaÃ§Ã£o. Tente com outro email.'
            });
          } else {
            // Couldn't compare, assume success
            resolve({ success: true, message: 'SubmissÃ£o enviada.' });
          }
        } catch (verifyError) {
          // Can't verify but submission was sent
          console.warn('âš ï¸ Verification failed, assuming success');
          resolve({ success: true, message: 'SubmissÃ£o enviada.' });
        }
      } catch (fallbackError) {
        console.error('âŒ All submission methods failed:', fallbackError);
        reject(fallbackError);
      }
    });
  }

  /**
   * Get current count via JSONP (always works cross-origin)
   */
  getCountViaJSONP() {
    return new Promise((resolve, reject) => {
      const callbackName = 'countCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);

      const timeout = setTimeout(() => {
        delete window[callbackName];
        const el = document.getElementById(callbackName);
        if (el) el.remove();
        reject(new Error('JSONP timeout'));
      }, 8000);

      window[callbackName] = function(response) {
        clearTimeout(timeout);
        delete window[callbackName];
        const el = document.getElementById(callbackName);
        if (el) el.remove();

        if (response && response.success) {
          resolve(response);
        } else {
          reject(new Error('JSONP failed'));
        }
      };

      const script = document.createElement('script');
      script.id = callbackName;
      script.src = `${RESERVAR_CONFIG.COUNT_ACTION_URL}?action=getCount&callback=${callbackName}&_t=${Date.now()}`;
      script.onerror = () => {
        clearTimeout(timeout);
        delete window[callbackName];
        reject(new Error('JSONP script error'));
      };
      document.head.appendChild(script);
    });
  }

  showSuccessModal() {
    const modal = document.getElementById('reservarSuccessModal');
    if (!modal) return;

    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');

    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusableElements.length > 0) {
      focusableElements[0].focus();
    }

    setTimeout(() => this.closeModal(), 5000);
  }

  closeModal() {
    const modal = document.getElementById('reservarSuccessModal');
    if (!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
  }
}

/* ============================================
   MODAL FUNCTIONS (Global for onclick)
   ============================================ */

function closeReservarModal() {
  const modal = document.getElementById('reservarSuccessModal');
  if (!modal) return;
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
}

window.addEventListener('click', function(e) {
  const modal = document.getElementById('reservarSuccessModal');
  if (e.target === modal) closeReservarModal();
});

window.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeReservarModal();
});

/* ============================================
   REMAINING SPOTS COUNTER
   ============================================ */

async function loadRemainingSpots() {
  if (!RESERVAR_CONFIG.COUNT_ACTION_URL ||
      RESERVAR_CONFIG.COUNT_ACTION_URL.includes('YOUR_SCRIPT_URL_HERE')) {
    updateSpotCounter(RESERVAR_CONFIG.MAX_SPOTS);
    return;
  }

  try {
    const url = `${RESERVAR_CONFIG.COUNT_ACTION_URL}?action=getCount&callback=handleReservarCountResponse`;
    const script = document.createElement('script');
    script.src = url;

    const timeout = setTimeout(() => {
      updateSpotCounter(RESERVAR_CONFIG.MAX_SPOTS);
    }, 5000);

    window.handleReservarCountResponse = function(response) {
      clearTimeout(timeout);
      if (response.success) {
        const remaining = RESERVAR_CONFIG.MAX_SPOTS - response.count;
        updateSpotCounter(remaining);
        if (remaining <= 0 && !RESERVAR_CONFIG.DEBUG_MODE) showListaCheia();
      } else {
        updateSpotCounter(RESERVAR_CONFIG.MAX_SPOTS);
      }
    };

    document.head.appendChild(script);
  } catch (error) {
    console.error('Error loading remaining spots:', error);
    updateSpotCounter(RESERVAR_CONFIG.MAX_SPOTS);
  }
}

function updateSpotCounter(count) {
  const spotElement = document.getElementById('remainingSpots');
  if (spotElement) spotElement.textContent = count;
}

function showListaCheia() {
  const mainContent = document.getElementById('reservarMainContent');
  const listaCheia = document.getElementById('reservarListaCheia');
  if (mainContent) mainContent.style.display = 'none';
  if (listaCheia) listaCheia.style.display = 'flex';
}

/* ============================================
   INITIALIZE ON DOM READY
   ============================================ */

document.addEventListener('DOMContentLoaded', () => {
  loadRemainingSpots();
  const carousel = new ReservarCarousel();
  const validator = new ReservarFormValidator('reservarForm');
  const submitter = new ReservarFormSubmitter('reservarForm', validator);
  console.log('ðŸ¾ Reservar section initialized');

  window.addEventListener('beforeunload', () => {
    if (carousel) carousel.destroy();
  });
});